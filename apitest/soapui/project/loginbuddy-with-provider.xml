<?xml version="1.0" encoding="UTF-8"?>
<con:soapui-project id="c43585a4-7207-4144-a409-d686ce46e01f" activeEnvironment="Default" name="LoginbuddyFakeProvider" resourceRoot="" soapui-version="5.5.0" abortOnError="false" runType="SEQUENTIAL" xmlns:con="http://eviware.com/soapui/config"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.actions.iface.tools.soapui.LoadTestRunnerAction@values-local"><![CDATA[<xml-fragment xmlns:con="http://eviware.com/soapui/config">
  <con:entry key="Print Report Statistics" value="false"/>
  <con:entry key="Report Format(s)" value=""/>
  <con:entry key="Host:Port" value=""/>
  <con:entry key="Save After" value="false"/>
  <con:entry key="Add Settings" value="false"/>
  <con:entry key="WSS Password Type" value=""/>
  <con:entry key="TestSuite" value="&lt;all>"/>
  <con:entry key="Endpoint" value=""/>
  <con:entry key="System Properties" value=""/>
  <con:entry key="Report to Generate" value=""/>
  <con:entry key="Password" value=""/>
  <con:entry key="LoadTest" value="&lt;all>"/>
  <con:entry key="Open Report" value="false"/>
  <con:entry key="Global Properties" value=""/>
  <con:entry key="Project Properties" value=""/>
  <con:entry key="ThreadCount" value=""/>
  <con:entry key="Project Password" value=""/>
  <con:entry key="TestCase" value="&lt;all>"/>
  <con:entry key="Username" value=""/>
  <con:entry key="user-settings.xml Password" value=""/>
  <con:entry key="TestRunner Path" value="/Applications/SoapUI-5.4.0.app/Contents/Resources/app/bin"/>
  <con:entry key="Environment" value="Default"/>
  <con:entry key="Limit" value=""/>
  <con:entry key="Root Folder" value=""/>
  <con:entry key="Domain" value=""/>
  <con:entry key="Tool Args" value=""/>
  <con:entry key="Save Project" value="false"/>
</xml-fragment>]]></con:setting></con:settings><con:testSuite id="cec7d4f7-7b18-484b-a4f8-3ac3deeeab0a" name="CompleteFlowWithFakeProvider"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="5bae8ed6-1bec-43ec-bb8a-956af32919c0" failOnError="true" failTestCaseOnErrors="true" keepSession="true" maxResults="0" name="Success" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword=""><con:settings/><con:testStep type="httprequest" name="client-loginbuddy-requestProviderList" id="f4974ee8-3892-4999-8e69-ce290e9dda11"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="f0816797-5bb4-411e-ab56-466ec164dc3c" name="client-loginbuddy-requestProviderList" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Client
  calls lbginbuddy to retrieve list of providers. This checks for the existence of the 'fake'
  provider for testing purposes.</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_authorize}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="6b8da209-0d46-453e-afb3-d0a434a9b51f" name="http-status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="Simple Contains" id="b8a7410e-0f24-46b2-813c-29db38945720" name="contains=&lt;html>"><con:configuration><token>&lt;html></token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>redirect_uri</con:name><con:value>${#Project#redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>state</con:name><con:value>${#Project#state}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>${#Project#client_id}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>response_type</con:name><con:value>code</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>scope</con:name><con:value>openid email profile</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="transfer" name="loginbuddy-getDetails" id="bff928aa-c0cd-4340-bd41-0be7ce7fe042"><con:description>Extract the 'state' parameter and get the 'action' which is the next location</con:description><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>form_action</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>client-loginbuddy-requestProviderList</con:sourceStep><con:sourcePath>//form[input/@value='${#Project#provider_test}']/@action</con:sourcePath><con:targetType>action</con:targetType><con:targetStep>loginbuddy-nextLocation</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" disabled="false" entitize="false" ignoreEmpty="false" transferChildNodes="false" transferToAll="false" useXQuery="false"><con:name>session</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>client-loginbuddy-requestProviderList</con:sourceStep><con:sourcePath>//form[input/@value='${#Project#provider_test}']/input[@name='session']/@value</con:sourcePath><con:targetType>session</con:targetType><con:targetStep>loginbuddy-selectFakeProvider</con:targetStep><con:targetPath xsi:nil="true"/><con:type>XPATH</con:type><con:targetTransferType>XPATH</con:targetTransferType><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="properties" name="loginbuddy-nextLocation" id="8861a199-87de-400d-86d7-0e98ef4fffc9"><con:description>Setting a variable to be used later as URL path</con:description><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>action</con:name><con:value>initialize</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="httprequest" name="loginbuddy-selectFakeProvider" id="3328560a-a037-4cbc-88ec-e641c525fb82"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="7a95031b-819e-4780-9c96-2bcc99423138" name="loginbuddy-selectFakeProvider" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Choosing
  the provider. Expects a
  redirect to the login page of the selected
  provider. Checks for required
  parameters</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}/${#action}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="3fd40551-e7ad-47cb-bb2d-f52c37bf1dc5" name="http-status=302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="8de45dc6-e7be-41d5-9d28-9ad09f0509cb" name="find 'Location' header and required parameters"><con:configuration><scriptText>// Find the 'Location' header of the response
    assert messageExchange.responseHeaders["Location"] != null

    def location = messageExchange.responseHeaders["Location"][0]

    // Check if all expected parameters are included in the redirect_uri
    assert(location.contains("client_id"));
    assert(location.contains("response_type=code"));
    assert(location.contains("scope=openid%20profile%20email"));
    assert(location.contains("nonce"));
    assert(location.contains("redirect_uri"));
    assert(location.contains("code_challenge"));
    assert(location.contains("code_challenge_method=S256"));
    assert(location.contains("state"));</scriptText></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>provider</con:name><con:value>${#Project#provider_test}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>session</con:name><con:value>c40a681f-14bf-4d61-a4a0-b77d54784609</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="groovy" name="loginbuddy-setProviderEndpoint" id="b6c27510-5df7-4306-b6ee-7628e00947cc"><con:description>Set the endpoint for the next test step</con:description><con:settings/><con:config><script>//Find the 'Location' header of the response
  def location =
  testRunner.testCase.testSteps["loginbuddy-selectFakeProvider"].testRequest.response.responseHeaders["Location"][0]

  // Write the 'location' into the 'endpoint' of the testStep 'callProvider'
  def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
  groovyUtils.setPropertyValue("loginbuddy-provider-callFakeProvider",
  "Endpoint", location.toString())</script></con:config></con:testStep><con:testStep type="httprequest" name="loginbuddy-provider-callFakeProvider" id="1d024f7f-31e1-4fdc-b395-0fef3025e9b6"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="be121e2d-1636-4a5d-ba1b-44ef31a40190" name="loginbuddy-provider-callFakeProvider" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Calls the providers authorization endpoint and receives a login page</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:encoding xsi:nil="true"/><con:endpoint><![CDATA[https://demoserver.loginbuddy.net/authorize?client_id=loginbuddy_demoId&response_type=code&scope=openid%20profile%20email&nonce=60448ffa-9003-4eba-b0f9-95775998e633&redirect_uri=https%3A%2F%2Flocal.loginbuddy.net%2Fcallback&code_challenge=nEPhx0_UGfoVWb3wadXsap0cAReNI50i3z1vzJEYRIU&code_challenge_method=S256&response_mode=query&state=c40a681f-14bf-4d61-a4a0-b77d54784609]]></con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="1ad74da4-00c8-49ad-a962-6cbbdae08127" name="status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="27d5881d-f6b6-4fd2-b89b-9898cde2c318" name="check for 'x-frame-options'"><con:configuration><scriptText>assert messageExchange.responseHeaders["X-Frame-Options"] != null</scriptText></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="transfer" name="provider-getState-Username" id="b8a6018a-63e1-4e5e-9b92-d6db15eec2cb"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>state</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>loginbuddy-provider-callFakeProvider</con:sourceStep><con:sourcePath>//input[@name='session']/@value</con:sourcePath><con:targetType>session</con:targetType><con:targetStep>provider-provideEmailAddress</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" disabled="false" entitize="false" ignoreEmpty="false" transferChildNodes="false" transferToAll="false" useXQuery="false"><con:name>action</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>loginbuddy-provider-callFakeProvider</con:sourceStep><con:sourcePath>//input[@name='action']/@value</con:sourcePath><con:targetType>action</con:targetType><con:targetStep>provider-provideEmailAddress</con:targetStep><con:targetPath xsi:nil="true"/><con:type>XPATH</con:type><con:targetTransferType>XPATH</con:targetTransferType><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="httprequest" name="provider-provideEmailAddress" id="e8bad344-d7a4-4a5a-b433-8c36f8fb01e7"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="71049774-abb4-455a-a78a-93f8b9736e24" name="provider-provideEmailAddress" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Inserting
  the users email address to be send to the login-endpoint of the provider</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:encoding xsi:nil="true"/><con:endpoint>${#Project#host_fake_server}/login</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="ae795b15-6bbb-4dfb-ad1e-af6d33edfdd0" name="statue=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>email</con:name><con:value>${#Project#email}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>session</con:name><con:value>4145fcee-389a-429a-8616-3fb277e9ef68</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>action</con:name><con:value>login</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="transfer" name="provider-getState-Password" id="3cb51161-ff9b-484a-a2b1-18956cd1ec71"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>state</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>provider-provideEmailAddress</con:sourceStep><con:sourcePath>//input[@name='session']/@value</con:sourcePath><con:targetType>session</con:targetType><con:targetStep>provider-providePassword</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" disabled="false" entitize="false" ignoreEmpty="false" transferChildNodes="false" transferToAll="false" useXQuery="false"><con:name>action</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>provider-provideEmailAddress</con:sourceStep><con:sourcePath>//input[@name='action']/@value</con:sourcePath><con:targetType>action</con:targetType><con:targetStep>provider-providePassword</con:targetStep><con:targetPath xsi:nil="true"/><con:type>XPATH</con:type><con:targetTransferType>XPATH</con:targetTransferType><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="httprequest" name="provider-providePassword" id="2ac1be17-87ac-4fec-ad95-f46ebf3db658"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="e05f9780-7ac5-41be-a84b-fb2425d8b4cd" name="provider-providePassword" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Inserting
  the users password to be send to the authenticate-endpoint of the provider</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>${#Project#host_fake_server}/authenticate</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="26cf303b-1eb4-484c-a132-9ef38be17d3e" name="status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>password</con:name><con:value>${#Project#password}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>session</con:name><con:value>4145fcee-389a-429a-8616-3fb277e9ef68</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>action</con:name><con:value>authenticate</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="transfer" name="provider-getState-Grant" id="b04ffe2f-52a2-4744-9de6-4f2bb1f93634"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>state</con:name><con:sourceType>ResponseAsXml</con:sourceType><con:sourceStep>provider-providePassword</con:sourceStep><con:sourcePath>//input[@name='session']/@value</con:sourcePath><con:targetType>session</con:targetType><con:targetStep>provider-grantAccess</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="httprequest" name="provider-grantAccess" id="efe7a649-a74e-448b-b961-bcf4a214a2cf"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="1c1997d7-7a13-416c-a6cd-fdc2b294865c" name="provider-grantAccess" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Providing
  the users grant to be send to the consent-endpoint of the provider</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host_fake_server}/consent</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="5ab02bdb-ebc1-40a6-a242-e361e7a4e0f5" name="status=200"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>action</con:name><con:value>grant</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>session</con:name><con:value>4145fcee-389a-429a-8616-3fb277e9ef68</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="groovy" name="loginbuddy-extractLocation" id="0c18fe1b-ac77-4231-85ca-06f182ceb90a"><con:description>Extract the state </con:description><con:settings/><con:config><script>//Takes one of the elements of the response Header
  def location =
  testRunner.testCase.testSteps["provider-grantAccess"].testRequest.response.responseHeaders["Location"][0]
  def code = location =~ /code=([^&amp;]+)/;
  if (!code) {
  throw new RuntimeException("No code returned!");
  }
  def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
  groovyUtils.setPropertyValue("loginbuddy-exchangeCodeForToken", "Endpoint", location)</script></con:config></con:testStep><con:testStep type="httprequest" name="loginbuddy-exchangeCodeForToken" id="2396ab80-8116-48d3-bbfe-27396ca61588"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="loginbuddy-exchangeCodeForToken" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Forward the 'state' and 'code' to loginbuddy. Loginbuddy then calls the providers token-endpoint. It then issues its own 'code'</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>https://local.loginbuddy.net/callback?state=c40a681f-14bf-4d61-a4a0-b77d54784609&amp;code=3a387cf9-c0e3-49ff-86e6-1c5799e8a01b</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="ccd972c0-afaf-4ae9-bd0d-69669a6fdf10" name="find: code and state"><con:configuration><scriptText>// Find the 'Location' header of the response
    assert messageExchange.responseHeaders["Location"] != null

    def location = messageExchange.responseHeaders["Location"][0]

    // Check if all expected parameters are included in the redirect_uri
    assert(location.contains("code"));
    assert(location.contains("state"));</scriptText></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="groovy" name="soapui-extractLocation" id="32e9b2a1-fb7e-4cba-8b2e-a6458fba7275"><con:description>Extract the state </con:description><con:settings/><con:config><script>//Takes one of the elements of the response Header
def location = testRunner.testCase.testSteps["loginbuddy-exchangeCodeForToken"].testRequest.response.responseHeaders["Location"][0]
def code = location =~ /code=([^&amp;]+)/;
if (!code) {
  throw new RuntimeException("No code returned!");
}
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("soapui-exchangeCodeForUserDetails", "code", code.group(1))</script></con:config></con:testStep><con:testStep type="httprequest" name="soapui-exchangeCodeForUserDetails" id="eb334346-85da-4773-976f-35b4c5a66515"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="soapui-exchangeCodeForUserDetails" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>The client uses its 'code' to retrieve the user details</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_token}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>code</con:name><con:value>ad8f4750-67be-4eb7-8f1d-97f235b1b372</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>${#Project#client_id}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>grant_type</con:name><con:value>authorization_code</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>redirect_uri</con:name><con:value>${#Project#redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="httprequest" name="soapui-codeNotTwice" id="331df15d-d684-4b84-a7a1-3e67b2195a19"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="soapui-codeNotTwice" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Verify that the 'code' can only be used once (here: success case)</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_token}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=400"><con:configuration><codes>400</codes></con:configuration></con:assertion><con:assertion type="Simple Contains" id="77a924a6-237e-491a-810e-09d8f0b6e7f6" name="contains: expired"><con:configuration><token>expired</token><ignoreCase>false</ignoreCase><useRegEx>false</useRegEx></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>code</con:name><con:value>0dd0b004-fbb6-4587-857e-822b3255b78a</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>${#Project#client_id}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>grant_type</con:name><con:value>authorization_code</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="httprequest" name="discovery" id="043545cb-34c2-474d-876c-7f6df4aa71b4"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="discovery" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Get the openid configuration, extract userinfo and jwks</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_discovery}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="transfer" name="OpenIDConfig Details" id="99d32a11-c0ec-43ac-a09b-4c2eeb73c8cf"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>userinfo</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>discovery</con:sourceStep><con:sourcePath>userinfo_endpoint</con:sourcePath><con:targetType>Endpoint</con:targetType><con:targetStep>userinfo via loginbuddy</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>access_token</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>soapui-exchangeCodeForUserDetails</con:sourceStep><con:sourcePath>access_token</con:sourcePath><con:targetType>access_token</con:targetType><con:targetStep>userinfo via loginbuddy</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="httprequest" name="userinfo via loginbuddy" id="2eaf7235-6321-46be-ba28-bbf5caa39e1b"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="userinfo via loginbuddy" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Verify that the 'code' can only be used once (here: success case)</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment xmlns:con="http://eviware.com/soapui/config">
  &lt;con:entry key="header1" value="value01"/>
  &lt;con:entry key="header1" value="value02"/>
&lt;/xml-fragment></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>https://local.loginbuddy.net/userinfo</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="JsonPath Match" id="1213f14f-6ecd-4d18-acec-88e9b87fc9e3" name="contain: email"><con:configuration><path>email</path><content>fake@emailaddress.com</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="GroovyScriptAssertion" id="bf233b99-184e-430a-99e4-ab6b3de67172" name="check: no x-frame-options header"><con:configuration><scriptText>assert messageExchange.responseHeaders["X-Frame-Options"] == null</scriptText></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>access_token</con:name><con:value>FAKE_121daf56-089a-4982-91bd-247c7efb7e9a</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:properties/></con:testCase><con:properties/></con:testSuite><con:testSuite id="71c80431-15cb-401e-8f8e-496fdc13b372" name="SelfissuedMe"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="719cb084-30a5-4825-85a2-81715706cceb" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="provider-selfissued" searchProperties="true"><con:settings/><con:testStep type="httprequest" name="authorize-selfissued" id="17a1d30e-13cb-4bc2-bc87-c42492c7c6bb"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="f0816797-5bb4-411e-ab56-466ec164dc3c" name="authorize-selfissued" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Client
  calls lbginbuddy to retrieve list of providers. This checks for the existence of the 'fake'
  provider for testing purposes.</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_authorize}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="6b8da209-0d46-453e-afb3-d0a434a9b51f" name="http-status=302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>redirect_uri</con:name><con:value>${#Project#redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>state</con:name><con:value>${#Project#state}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>${#Project#client_id}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>response_type</con:name><con:value>id_token</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>provider</con:name><con:value>self-issued</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>scope</con:name><con:value>openid email profile</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="groovy" name="Extract Location" id="8513c20d-9b2a-4387-9a11-4c4bdc4912eb"><con:settings/><con:config><script>//Find the 'Location' header of the response
def location = testRunner.testCase.testSteps["authorize-selfissued"].testRequest.response.responseHeaders["Location"][0]

// Write the 'location' into the 'endpoint' of the testStep 'test-step-target'
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("initialize-selfissued", "Endpoint", location.toString())

// Extract session
def sessionId = location.split("session=")[1]
assert sessionId != null
groovyUtils.setPropertyValue("Properties", "sessionId", sessionId)</script></con:config></con:testStep><con:testStep type="httprequest" name="initialize-selfissued" id="56e46be8-9514-4bee-858a-4d64caa210db"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="6cdb03a8-d741-4015-9cd8-84e6e40d1dc9" name="initialize-selfissued" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>https://local.loginbuddy.net/initialize?session=5565cb47-89f9-4165-9525-eb7f0afef7c2</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="0050bfda-7439-4eef-be48-79c764e7b000" name="status: 302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="groovy" name="Extract Location - scheme = openid" id="58cd1b0b-a5fe-481c-9849-1fbd61eee84a"><con:settings/><con:config><script>//Find the 'Location' header of the response
def location = testRunner.testCase.testSteps["initialize-selfissued"].testRequest.response.responseHeaders["Location"][0]
assert location.startsWith('openid://');

// Extract redirect_uri
def redirectUri = location.split("redirect_uri=")[1]
redirectUri = redirectUri.split("&amp;")[0]
assert redirectUri != null

// Extract nonce
def nonce = location.split("nonce=")[1]
nonce = nonce.split("&amp;")[0]

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("Properties", "redirectUri", new URLDecoder().decode(redirectUri))
groovyUtils.setPropertyValue("Get JWT for test", "nonce", new URLDecoder().decode(nonce))</script></con:config></con:testStep><con:testStep type="httprequest" name="Get JWT for test" id="f8f9e387-51cb-4ba1-a746-3723ba00ba2b"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="a42c8684-e3fb-480d-848f-2cc38bde343a" name="Get JWT for test" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Simulates an id_token issued by self-issued provider</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:encoding xsi:nil="true"/><con:endpoint>${#Project#helper_host}${#Project#helper_path_jwt}</con:endpoint><con:request/><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>issuer</con:name><con:value>https://self-issued.me</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>audience</con:name><con:value>${#Project#helper_redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>subject</con:name><con:value>arandomvalue</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>nonce</con:name><con:value>79a28377-b2dc-4203-9aef-5aea49be7b65</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="transfer" name="GetHelperData" id="797af334-a27e-4892-987b-0f687a8a1ade"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>idtoken</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>Get JWT for test</con:sourceStep><con:sourcePath>jwt</con:sourcePath><con:targetType>idtoken</con:targetType><con:targetStep>Properties</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="properties" name="Properties" id="e7fb8cbc-9ac6-4c40-a727-a2671872fed6"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>sessionId</con:name><con:value>5565cb47-89f9-4165-9525-eb7f0afef7c2</con:value></con:property><con:property><con:name>redirectUri</con:name><con:value>https://local.loginbuddy.net/callback/selfissued</con:value></con:property><con:property><con:name>idtoken</con:name><con:value>eyJraWQiOiJhOWQ4Y2NiZS0zYzQxLTRjYTMtOTQyNy0xZmY0N2ZiYjE3ZTYiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJodHRwczovL3NlbGYtaXNzdWVkLm1lIiwic3ViIjoiYXJhbmRvbXZhbHVlIiwiYXVkIjoiaHR0cHM6Ly9sb2NhbC5sb2dpbmJ1ZGR5Lm5ldC9jYWxsYmFjay9zZWxmaXNzdWVkIiwibm9uY2UiOiI3OWEyODM3Ny1iMmRjLTQyMDMtOWFlZi01YWVhNDliZTdiNjUiLCJleHAiOjE1NzM2MjYxNzksImlhdCI6MTU3MzYyNjExOSwianRpIjoib0lCWWxyTHU5blVmUHd5aTkxaWlwQSIsIm5iZiI6MTU3MzYyNTk5OSwic3ViX2p3ayI6eyJrdHkiOiJSU0EiLCJlIjoiQVFBQiIsImtpZCI6ImE5ZDhjY2JlLTNjNDEtNGNhMy05NDI3LTFmZjQ3ZmJiMTdlNiIsIm4iOiJyWDlUdzVOR2V1OU9OY2VhZDZSdjVkUTlCZ25OMzRWMFBmTlRQRWltN192d2Z3ZmkxTnNSTWI5UTI2QU14Q1BGUzdILWVxMXRVT0tzNFAtQkY2VlNJYXBzVFRDckxBVFROdE9pUHk0MkQ3cXBwaFBtU1FOaWZYNGVZZUxRSWdvVW5JSmx0MDhSY0NtV2R6TUJwSEtXZGs4bzBoVjNscVVTbC1SNFdIbFJkQ0VZa1FieF82OU5CZWdmenc1Uk8xVnI3cXZfdjhhR1hsSkFmR2c3b2hXNXdvUWs1TGZialZWZFVqZm1QNkFYcF9YN182YXE1eTNtenFwTjdsN2xvZ2hQckg4alZVeF91Zm5COXp5ajhQNVNHUGtoaDVJaFhQN1ZjZkNCRE5BbTBWcjg1NXk5OGpJYjdXOElkeW9oUHdXd1FtUVZOdVBQamNrS3k4RGt5di1JRHcifX0.HIELSGRDqHT8FXtHbn6fsEd4bRFOgT0RLxYkB9l1ayKRIV7f540MjYNwVAnQv4yB401NL5Rm-jS50JAG-o4LF9l7_DSfth3iaogoVpDHLARN0IWT4wylyMZrSAkxQJsGXBx5r2Jv1cr_mbF1NLFPgU-xZjNVQNJv3AoEEvZFvyIxa3LG6Kak9RK-1WzK-_YBySYTqbQlCw3yKLX4ryYLe2F4dWDizrq2oye1nMm85iS02vX4IxRjycc3XAQpJXCQHh0AOqFwofdX7e8hoAlOgvJNhBdkVLI58F_5rIFada5XiNOu8QAp1LVHrpzG609Sz2iNU4AZcjjj0G1eqrcMwQ</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="httprequest" name="send-selfissued-response" id="17a993ef-da3d-4571-b1b1-182deda9abb1"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="654b3799-a13e-4701-b200-4b2db07c7d38" name="send-selfissued-response" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${redirectUri}?state=${sessionId}&amp;id_token=${idtoken}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="2935e32e-f3b0-4c00-8b15-163d4d6a224a" name="status: 302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="groovy" name="soapui-extractLocation" id="9fc8e5f7-e72d-4358-95e1-39e0d1c94452"><con:description>Extract the state </con:description><con:settings/><con:config><script>//Takes one of the elements of the response Header
def location = testRunner.testCase.testSteps["send-selfissued-response"].testRequest.response.responseHeaders["Location"][0]
def code = location =~ /code=([^&amp;]+)/;
if (!code) {
  throw new RuntimeException("No code returned!");
}
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("soapui-exchangeCodeForUserDetails", "code", code.group(1))</script></con:config></con:testStep><con:testStep type="httprequest" name="soapui-exchangeCodeForUserDetails" id="c53dd9eb-2d0e-4ab4-95fb-9ea9bf008f1f"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="soapui-exchangeCodeForUserDetails" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>The client uses its 'code' to retrieve the user details</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_token}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="JsonPath Existence Match" id="77c12905-99eb-4c1a-a77b-3e091bc8bf9e" name="contains: id_token"><con:configuration><path>id_token</path><content>true</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="JsonPath Match" id="7b860728-8aec-4276-beb1-3c5bafedbf79" name="sub: arandomvalue"><con:configuration><path>$.details_provider.id_token_payload.sub</path><content>arandomvalue</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>code</con:name><con:value>b5fc199b-4729-4d69-b23f-e73bc4b179d4</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>${#Project#client_id}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>grant_type</con:name><con:value>authorization_code</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>redirect_uri</con:name><con:value>${#Project#redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:properties/></con:testCase><con:testCase id="5436320c-e916-46e5-b60d-fd4319c5c461" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="provider-selfissued-dynamic-registration" searchProperties="true"><con:settings/><con:testStep type="httprequest" name="register" id="6e294301-704e-4057-be13-f7bc5a2c3a6e"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="f0816797-5bb4-411e-ab56-466ec164dc3c" name="register" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Client
  calls lbginbuddy to retrieve list of providers. This checks for the existence of the 'fake'
  provider for testing purposes.</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host_oidcdr}${#Project#path_oidcdr_register}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="6b8da209-0d46-453e-afb3-d0a434a9b51f" name="status: 200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="JsonPath Match" id="24f4a9b6-8f8d-4d0b-86e9-9455be9c389d" name="check: client_id matches redirect_uri"><con:configuration><path>client_id</path><content>${#Project#redirect_uri}</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="JsonPath Match" id="65f80596-5da4-4c6b-aec6-b6b34f0b7025" name="check: authorizaiton_endpoint = openid://"><con:configuration><path>authorization_endpoint</path><content>openid://</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>issuer</con:name><con:value>${#Project#issuer_selfissued}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>redirect_uri</con:name><con:value>${#Project#redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="transfer" name="RegistrationDetails" id="2fe073c7-bf0d-41c4-93f7-9b3899070101" disabled="true"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>provider</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>register</con:sourceStep><con:sourcePath>provider</con:sourcePath><con:targetType>provider</con:targetType><con:targetStep>authorize-selfissued</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>client_id</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>register</con:sourceStep><con:sourcePath>client_id</con:sourcePath><con:targetType>client_id</con:targetType><con:targetStep>authorize-selfissued</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>response_type</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>register</con:sourceStep><con:sourcePath>response_type</con:sourcePath><con:targetType>response_type</con:targetType><con:targetStep>authorize-selfissued</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>scope</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>register</con:sourceStep><con:sourcePath>scope</con:sourcePath><con:targetType>scope</con:targetType><con:targetStep>authorize-selfissued</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>redirect_uri</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>register</con:sourceStep><con:sourcePath>redirect_uri</con:sourcePath><con:targetType xsi:nil="true"/><con:targetStep>authorize-selfissued</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="httprequest" name="authorize-selfissued" id="b556b418-d69b-430a-be56-5e7808fdcd0c" disabled="true"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="f0816797-5bb4-411e-ab56-466ec164dc3c" name="authorize-selfissued" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Client
  calls lbginbuddy to retrieve list of providers. This checks for the existence of the 'fake'
  provider for testing purposes.</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_authorize}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="6b8da209-0d46-453e-afb3-d0a434a9b51f" name="http-status=302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>redirect_uri</con:name><con:value>https://local.soapui.com/redirect</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>state</con:name><con:value>${#Project#state}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>https://local.soapui.com/redirect</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>response_type</con:name><con:value>code</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>provider</con:name><con:value>https://self-issued.me</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>scope</con:name><con:value>openid profile email address phone</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="groovy" name="Extract Location" id="ae418943-fffa-47fb-b442-b5d12af2a786" disabled="true"><con:settings/><con:config><script>//Find the 'Location' header of the response
def location = testRunner.testCase.testSteps["authorize-selfissued"].testRequest.response.responseHeaders["Location"][0]

// Write the 'location' into the 'endpoint' of the testStep 'test-step-target'
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("initialize-selfissued", "Endpoint", location.toString())

// Extract session
def sessionId = location.split("session=")[1]
assert sessionId != null
groovyUtils.setPropertyValue("Properties", "sessionId", sessionId)</script></con:config></con:testStep><con:testStep type="httprequest" name="initialize-selfissued" id="06a2730c-40e0-4a4d-8d38-03bb6878fa53" disabled="true"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="6cdb03a8-d741-4015-9cd8-84e6e40d1dc9" name="initialize-selfissued" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>https://local.loginbuddy.net/initialize?session=e6153f6b-c7b9-4637-9e72-ad861ae6c2c8</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="0050bfda-7439-4eef-be48-79c764e7b000" name="status: 302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="groovy" name="Extract Location - scheme = openid" id="cd457156-a5c6-4fff-87d6-3e0ea2d904ef" disabled="true"><con:settings/><con:config><script>//Find the 'Location' header of the response
def location = testRunner.testCase.testSteps["initialize-selfissued"].testRequest.response.responseHeaders["Location"][0]
assert location.startsWith('openid://');

// Extract redirect_uri
def redirectUri = location.split("redirect_uri=")[1]
redirectUri = redirectUri.split("&amp;")[0]
assert redirectUri != null

// Extract nonce
def nonce = location.split("nonce=")[1]
nonce = nonce.split("&amp;")[0]

def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("Properties", "redirectUri", new URLDecoder().decode(redirectUri))
groovyUtils.setPropertyValue("Get JWT for test", "nonce", new URLDecoder().decode(nonce))</script></con:config></con:testStep><con:testStep type="httprequest" name="Get JWT for test" id="b265ee7f-956f-4c75-bd10-c466af456edd" disabled="true"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="a42c8684-e3fb-480d-848f-2cc38bde343a" name="Get JWT for test" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>Simulates an id_token issued by self-issued provider</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:encoding xsi:nil="true"/><con:endpoint>${#Project#helper_host}${#Project#helper_path_jwt}</con:endpoint><con:request/><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>issuer</con:name><con:value>https://self-issued.me</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>audience</con:name><con:value>${#Project#helper_redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>subject</con:name><con:value>arandomvalue</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>nonce</con:name><con:value>42b8c0f4-60d5-4321-8ad7-f91414b9d98d</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:testStep type="transfer" name="GetHelperData" id="7bee8909-b44c-44cb-bc2b-56ba000edd04" disabled="true"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>idtoken</con:name><con:sourceType>Response</con:sourceType><con:sourceStep>Get JWT for test</con:sourceStep><con:sourcePath>jwt</con:sourcePath><con:targetType>idtoken</con:targetType><con:targetStep>Properties</con:targetStep><con:type>JSONPATH</con:type><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="properties" name="Properties" id="33cd3847-0bd9-4432-92bd-16714c0e996b" disabled="true"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>sessionId</con:name><con:value>e6153f6b-c7b9-4637-9e72-ad861ae6c2c8</con:value></con:property><con:property><con:name>redirectUri</con:name><con:value>https://local.loginbuddy.net/callback/selfissued</con:value></con:property><con:property><con:name>idtoken</con:name><con:value>eyJraWQiOiJkYmUzNWExYS1lYTM5LTQzMDktYjQ5Mi1iMTg1MThkODBmYWIiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJodHRwczovL3NlbGYtaXNzdWVkLm1lIiwic3ViIjoiYXJhbmRvbXZhbHVlIiwiYXVkIjoiaHR0cHM6Ly9sb2NhbC5sb2dpbmJ1ZGR5Lm5ldC9jYWxsYmFjay9zZWxmaXNzdWVkIiwibm9uY2UiOiI0MmI4YzBmNC02MGQ1LTQzMjEtOGFkNy1mOTE0MTRiOWQ5OGQiLCJleHAiOjE1NzM2MjM1MTgsImlhdCI6MTU3MzYyMzQ1OCwianRpIjoiNzFLYkExWE9zZG45NjJNU09nLTdFQSIsIm5iZiI6MTU3MzYyMzMzOCwic3ViX2p3ayI6eyJrdHkiOiJSU0EiLCJlIjoiQVFBQiIsImtpZCI6ImRiZTM1YTFhLWVhMzktNDMwOS1iNDkyLWIxODUxOGQ4MGZhYiIsIm4iOiJvUGxSc0NnRWMtMTcwYWpzaWt2U2hlR1pQOC1Qd0FJZlFRMy1RRGYxQm1WdkU4RlV4amhvckx0M3FPTi16ZC1YemVocUx2VzVlVS1Hb0NOSlhKU1hOY01BZEdHUUVfWW1HVHI2WDdwTG5tX3k5TVJydGJXd2RVUmN2WDNJWlJuR0cwek4zUnJ1RXdobzF6TDlxRXpCeG9YeGE2R3MxNHNqVkpOUnZsXzlrdkw3QmZ0YjZzcGdRanREMUhTbG9rS00wNnFUdzZaQ3YtN3oxUXVGTllPM0RJVVBqRWc0Uk1LM1FRWk42TTRxc2h6X3Z6Q0FTczk2MXFWSmdGSFVFNHB6S0owYWxlc0I5bWVLVlZKOUpja0Q5ZDZrMEVxbWJ3MExlM192c3M1Zm9ZeUI0RFNQaVhudTlFWEFDS2NvenA1c3ViQ090NFVNMVhPSVV4VVpESWdYOVEifX0.NrYoRBsBnj5EJC6G51i15sJ9IegvLaMPkzrD41aJZjDXqIfEWVr-AwkeJddGQKRVPdr7yFYdV5zh6kpUh_au85dO-W0Fhg6RtBh_FtUYuzX62D1uo9BaKs9GdGbCn7kz8ZFJYltz6JUUZj6jrY6LYdRXrQI4Jq6AU6OjDeXoptWYWQVoZMt7rxuBXKmRm5T9zXxOgzVNjhYsn62bluyU3kDmoSO0tETvdRX8B6RtS4rbvtlkCSx697OvvdsPzkYySf-UVdWIuEWZmsugFQiedctbfKMvveUTg8sYe51xYgPcdyLujth5pEO7Q7HNblMYZ49Lu_6LJ3vB6ZsdT_Vosw</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="httprequest" name="send-selfissued-response" id="3723c1bd-6561-4d75-a219-e2d4fdf38d4c" disabled="true"><con:settings/><con:config method="GET" xsi:type="con:HttpRequest" id="654b3799-a13e-4701-b200-4b2db07c7d38" name="send-selfissued-response" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${redirectUri}?state=${sessionId}&amp;id_token=${idtoken}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="2935e32e-f3b0-4c00-8b15-163d4d6a224a" name="status: 302"><con:configuration><codes>302</codes></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:config></con:testStep><con:testStep type="groovy" name="soapui-extractLocation" id="0ec59084-4da5-456f-bd29-fee8775a0540" disabled="true"><con:description>Extract the state </con:description><con:settings/><con:config><script>//Takes one of the elements of the response Header
def location = testRunner.testCase.testSteps["send-selfissued-response"].testRequest.response.responseHeaders["Location"][0]
def code = location =~ /code=([^&amp;]+)/;
if (!code) {
  throw new RuntimeException("No code returned!");
}
def groovyUtils = new com.eviware.soapui.support.GroovyUtils( context )
groovyUtils.setPropertyValue("soapui-exchangeCodeForUserDetails", "code", code.group(1))</script></con:config></con:testStep><con:testStep type="httprequest" name="soapui-exchangeCodeForUserDetails" id="64bbe017-2919-4b74-926c-f637fb398cbd" disabled="true"><con:settings/><con:config method="POST" xsi:type="con:HttpRequest" id="cd652fe8-aecf-415b-87ba-8f11fe434d36" name="soapui-exchangeCodeForUserDetails" postQueryString="true" mediaType="application/x-www-form-urlencoded" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:description>The client uses its 'code' to retrieve the user details</con:description><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="cookie" value="${#jsession}" xmlns="http://eviware.com/soapui/config"/></con:setting><con:setting id="com.eviware.soapui.impl.support.AbstractHttpRequest@follow-redirects">false</con:setting></con:settings><con:endpoint>${#Project#host}${#Project#path_token}</con:endpoint><con:request/><con:assertion type="Valid HTTP Status Codes" id="7476d2de-0271-444e-b51d-79a256a51538" name="http-status=200"><con:configuration><codes>200</codes></con:configuration></con:assertion><con:assertion type="JsonPath Existence Match" id="77c12905-99eb-4c1a-a77b-3e091bc8bf9e" name="contains: id_token"><con:configuration><path>id_token</path><content>true</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:assertion type="JsonPath Match" id="7b860728-8aec-4276-beb1-3c5bafedbf79" name="sub: arandomvalue"><con:configuration><path>$.details_provider.id_token_payload.sub</path><content>arandomvalue</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><con:parameter><con:name>code</con:name><con:value>32f70081-2714-453d-b692-dea3852eba8b</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>client_id</con:name><con:value>${#Project#client_id}</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>grant_type</con:name><con:value>authorization_code</con:value><con:style>QUERY</con:style></con:parameter><con:parameter><con:name>redirect_uri</con:name><con:value>${#Project#redirect_uri}</con:value><con:style>QUERY</con:style></con:parameter></con:parameters></con:config></con:testStep><con:properties/></con:testCase><con:properties/></con:testSuite><con:properties><con:property><con:name>host</con:name><con:value>https://local.loginbuddy.net</con:value></con:property><con:property><con:name>host_http</con:name><con:value>http://local.loginbuddy.net</con:value></con:property><con:property><con:name>redirect_uri</con:name><con:value>https://local.soapui.com/redirect</con:value></con:property><con:property><con:name>client_id</con:name><con:value>clientIdForTestingPurposes</con:value></con:property><con:property><con:name>client_secret</con:name><con:value>d5453153-e096-4672-bcb5-313d9847c8de</con:value></con:property><con:property><con:name>provider_test</con:name><con:value>server_loginbuddy</con:value></con:property><con:property><con:name>host_fake_Server</con:name><con:value>https://demoserver.loginbuddy.net</con:value></con:property><con:property><con:name>email</con:name><con:value>fake@emailaddress.com</con:value></con:property><con:property><con:name>password</con:name><con:value>fakePAssword</con:value></con:property><con:property><con:name>state</con:name><con:value>sopauiFakeState</con:value></con:property><con:property><con:name>path_initialize</con:name><con:value>/initialize</con:value></con:property><con:property><con:name>path_callback</con:name><con:value>/callback</con:value></con:property><con:property><con:name>path_providers_jsp</con:name><con:value>/iapis/providers.jsp</con:value></con:property><con:property><con:name>path_error_jsp</con:name><con:value>/iapis/error.jsp</con:value></con:property><con:property><con:name>path_authorize</con:name><con:value>/authorize</con:value></con:property><con:property><con:name>path_token</con:name><con:value>/token</con:value></con:property><con:property><con:name>path_discovery</con:name><con:value>/.well-known/openid-configuration</con:value></con:property><con:property><con:name>helper_path_jwt</con:name><con:value>/test/generate/jwt</con:value></con:property><con:property><con:name>helper_host</con:name><con:value>http://local.loginbuddy.net:8999</con:value></con:property><con:property><con:name>helper_redirect_uri</con:name><con:value>https://local.loginbuddy.net/callback/selfissued</con:value></con:property><con:property><con:name>host_oidcdr</con:name><con:value>https://loginbuddy-oidcdr:445</con:value></con:property><con:property><con:name>path_oidcdr_register</con:name><con:value>/oidcdr/register</con:value></con:property><con:property><con:name>issuer_selfissued</con:name><con:value>https://self-issued.me</con:value></con:property></con:properties><con:wssContainer/><con:oAuth2ProfileContainer/><con:oAuth1ProfileContainer/><con:sensitiveInformation/></con:soapui-project>